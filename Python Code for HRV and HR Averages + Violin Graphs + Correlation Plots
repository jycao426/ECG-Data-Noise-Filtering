import os
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from scipy.stats import pearsonr

# Step 1: Load the file
data_folder_path = '/content/drive/MyDrive/ECG Report'
input_file = os.path.join(data_folder_path, 'ALL DATA Mouse 1+2 - HR.csv')
df = pd.read_csv(input_file)

# Step 2: Melt to long format
df_long = df.melt(id_vars=['Animal', 'Session'],
                  var_name='Simulation',
                  value_name='HR')

# Step 3: Add Source and BaseSim columns
df_long["Source"] = df_long["Simulation"].apply(lambda x: "ECGenie" if x.endswith("-ECGenie") else "MyAlgorithm")
df_long["BaseSim"] = df_long["Simulation"].str.replace("-ECGenie", "", regex=False)

# Step 4: Remove invalid HR values
df_long = df_long.dropna(subset=["HR"])
df_long = df_long[df_long["HR"] > 0]

# Step 5: Compute averages for plotting
avg_df = df_long.groupby(['Animal', 'Session', 'Simulation'])['HR'].mean().reset_index()

# Step 6: Save averages
output_file = os.path.join(data_folder_path, 'HR_Averages_By_Simulation.csv')
avg_df.to_csv(output_file, index=False)
print(f"‚úÖ Averages by simulation saved to: {output_file}")

# Step 7: Violin plot by simulation
custom_palette = {1: "#F28E8E", 2: "#4F81BD"}
plt.figure(figsize=(12, 6))
sns.violinplot(data=avg_df, x='Simulation', y='HR', hue='Animal', split=True, inner='box', palette=custom_palette)
plt.title("Heart Rate (BPM) Across Simulations and Mice")
plt.xlabel("Simulation Condition")
plt.ylabel("Average HR (BPM)")
plt.grid(True)
plt.tight_layout()
plt.show()

# Step 8: Violin plot by Animal
plt.figure(figsize=(10, 6))
sns.violinplot(data=avg_df, x='Animal', y='HR', hue='Simulation', inner='box')
plt.title("HR (BPM) Comparison Between Mice by Simulation")
plt.xlabel("Mouse ID")
plt.ylabel("Average HR (BPM)")
plt.grid(True)
plt.tight_layout()
plt.show()

# Step 9: Coefficient of Variation (CV)
cv_results = (
    df_long.groupby(["Animal", "BaseSim", "Source"])["HR"]
    .agg(['mean', 'std'])
    .reset_index()
)
cv_results["CV (%)"] = (cv_results["std"] / cv_results["mean"]) * 100
print("\nüìä Coefficient of Variation (CV) by Mouse and Simulation:")
print(cv_results)
cv_results.to_csv(os.path.join(data_folder_path, 'HR_CV_ECGenie_vs_Algorithm.csv'), index=False)

# Step 10: Correlation on individual values
df_long["GroupID"] = df_long["Animal"].astype(str) + "_" + df_long["Session"].astype(str) + "_" + df_long["BaseSim"]

# Step 11: Split by source and align within groups
ecg = df_long[df_long["Source"] == "ECGenie"].copy().sort_values("GroupID").groupby("GroupID").apply(lambda x: x.reset_index(drop=True))
myalg = df_long[df_long["Source"] == "MyAlgorithm"].copy().sort_values("GroupID").groupby("GroupID").apply(lambda x: x.reset_index(drop=True))

merged = ecg[["GroupID", "HR"]].rename(columns={"HR": "HR_ECGenie"}).reset_index(drop=True)
merged["HR_MyAlgo"] = myalg["HR"].reset_index(drop=True)
merged[["Animal", "Session", "BaseSim"]] = merged["GroupID"].str.split("_", expand=True)

# Step 12: Plot individual correlation
plt.figure(figsize=(8, 6))
sns.scatterplot(data=merged, x="HR_MyAlgo", y="HR_ECGenie", hue="BaseSim", style="Animal", palette="Set2", s=100)
min_val = min(merged["HR_MyAlgo"].min(), merged["HR_ECGenie"].min())
max_val = max(merged["HR_MyAlgo"].max(), merged["HR_ECGenie"].max())
plt.plot([min_val, max_val], [min_val, max_val], 'r--', label='Perfect Correlation')
plt.xlabel("My Algorithm HR")
plt.ylabel("ECGenie HR")
plt.title("Correlation Between Individual HR Points")
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()

# Step 13: Pearson r on individual values
if len(merged) >= 2:
    r, p = pearsonr(merged["HR_MyAlgo"], merged["HR_ECGenie"])
    print(f"üìà Pearson Correlation (All Points): r = {r:.3f} (p = {p:.4f})")
else:
    print("‚ùå Not enough individual points for correlation.")

# Step 14: Correlation using averages
avg_df["Source"] = avg_df["Simulation"].apply(lambda x: "ECGenie" if x.endswith("-ECGenie") else "MyAlgorithm")
avg_df["BaseSim"] = avg_df["Simulation"].str.replace("-ECGenie", "", regex=False)
avg_df["Key"] = avg_df["Animal"].astype(str) + "_" + avg_df["Session"].astype(str) + "_" + avg_df["BaseSim"]

avg_algo = avg_df[avg_df["Source"] == "MyAlgorithm"]
avg_ecg = avg_df[avg_df["Source"] == "ECGenie"]

avg_merged = pd.merge(
    avg_algo[["Key", "HR", "Animal", "BaseSim"]],
    avg_ecg[["Key", "HR"]],
    on="Key",
    suffixes=("_MyAlgo", "_ECGenie")
)

# Step 15: Correlation plot for averages
plt.figure(figsize=(8, 6))
sns.scatterplot(data=avg_merged, x="HR_MyAlgo", y="HR_ECGenie", hue="BaseSim", style="Animal", palette="Set1", s=100)
min_val = min(avg_merged["HR_MyAlgo"].min(), avg_merged["HR_ECGenie"].min())
max_val = max(avg_merged["HR_MyAlgo"].max(), avg_merged["HR_ECGenie"].max())
plt.plot([min_val, max_val], [min_val, max_val], 'r--', label='Perfect Correlation')
plt.xlabel("My Algorithm Avg HR")
plt.ylabel("ECGenie Avg HR")
plt.title("üìä Correlation of AVERAGE HR Between My Algorithm and ECGenie")
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

# Step 16: Pearson r on averages
if len(avg_merged) >= 2:
    r_avg, p_avg = pearsonr(avg_merged["HR_MyAlgo"], avg_merged["HR_ECGenie"])
    print(f"üìà Pearson Correlation (Averages): r = {r_avg:.3f} (p = {p_avg:.4f})")
else:
    print("‚ùå Not enough averaged points for correlation.")

# Step 1: Filter only MyAlgorithm data
myalg_only = avg_df[avg_df["Source"] == "MyAlgorithm"].copy()

# Step 2: Strip ECGenie suffix if not already done
myalg_only["BaseSim"] = myalg_only["Simulation"].str.replace("-ECGenie", "", regex=False)

# Step 3: Group by simulation type and average across mice
grouped_avg = myalg_only.groupby("BaseSim")["HR"].mean().reset_index()

# Step 4: Merge averaged HR back for plotting with violin shape (add dummy mouse column)
myalg_only["BaseSim"] = myalg_only["Simulation"].str.replace("-ECGenie", "", regex=False)

# Plot: Violin of HR from MyAlgorithm across simulation types
plt.figure(figsize=(10, 6))
sns.violinplot(data=myalg_only, x="BaseSim", y="HR", inner="box", palette="Set2")
plt.title("MyAlgorithm: Heart Rate Comparison Across Simulation Types (Avg Across Mice)")
plt.xlabel("Simulation Type")
plt.ylabel("Heart Rate (BPM)")
plt.grid(True)
plt.tight_layout()
plt.show()

# Step 1: Filter only MyAlgorithm HRV data
myalg_hrv = avg_df[(avg_df["Source"] == "MyAlgorithm")].copy()

# Step 2: Strip ECGenie suffix to get base simulation name
myalg_hrv["BaseSim"] = myalg_hrv["Simulation"].str.replace("-ECGenie", "", regex=False)

# Step 3: Plot HRV distribution across simulations (all sessions & mice)
plt.figure(figsize=(10, 6))
sns.violinplot(data=myalg_hrv, x="BaseSim", y="HRV", inner="box", palette="Set2")
plt.title("MyAlgorithm: HRV Comparison Across Simulation Types (All Mice)")
plt.xlabel("Simulation Type")
plt.ylabel("HRV (BPM)")
plt.grid(True)
plt.tight_layout()
plt.show()



# FOR HR(BPM)
import os
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from scipy.stats import pearsonr

# Step 1: Load the file
data_folder_path = '/content/drive/MyDrive/ECG Report'
input_file = os.path.join(data_folder_path, 'ALL DATA Mouse 1+2 - HR.csv')
df = pd.read_csv(input_file)

# Step 2: Melt to long format
df_long = df.melt(id_vars=['Animal', 'Session'],
                  var_name='Simulation',
                  value_name='HR')

# Step 3: Add Source and BaseSim columns
df_long["Source"] = df_long["Simulation"].apply(lambda x: "ECGenie" if x.endswith("-ECGenie") else "MyAlgorithm")
df_long["BaseSim"] = df_long["Simulation"].str.replace("-ECGenie", "", regex=False)

# Step 4: Remove invalid HR values
df_long = df_long.dropna(subset=["HR"])
df_long = df_long[df_long["HR"] > 0]

# Step 5: Compute averages for plotting
avg_df = df_long.groupby(['Animal', 'Session', 'Simulation'])['HR'].mean().reset_index()

# Step 6: Save averages
output_file = os.path.join(data_folder_path, 'HR_Averages_By_Simulation.csv')
avg_df.to_csv(output_file, index=False)
print(f"‚úÖ Averages by simulation saved to: {output_file}")

# Step 7: Violin plot by simulation
custom_palette = {1: "#F28E8E", 2: "#4F81BD"}
plt.figure(figsize=(12, 6))
sns.violinplot(data=avg_df, x='Simulation', y='HR', hue='Animal', split=True, inner='box', palette=custom_palette)
plt.title("Heart Rate (BPM) Across Simulations and Mice")
plt.xlabel("Simulation Condition")
plt.ylabel("Average HR (BPM)")
plt.grid(True)
plt.tight_layout()
plt.show()

# Step 8: Violin plot by Animal
plt.figure(figsize=(10, 6))
sns.violinplot(data=avg_df, x='Animal', y='HR', hue='Simulation', inner='box')
plt.title("HR (BPM) Comparison Between Mice by Simulation")
plt.xlabel("Mouse ID")
plt.ylabel("Average HR (BPM)")
plt.grid(True)
plt.tight_layout()
plt.show()

# Step 9: Coefficient of Variation (CV)
cv_results = (
    df_long.groupby(["Animal", "BaseSim", "Source"])["HR"]
    .agg(['mean', 'std'])
    .reset_index()
)
cv_results["CV (%)"] = (cv_results["std"] / cv_results["mean"]) * 100
print("\nüìä Coefficient of Variation (CV) by Mouse and Simulation:")
print(cv_results)
cv_results.to_csv(os.path.join(data_folder_path, 'HR_CV_ECGenie_vs_Algorithm.csv'), index=False)

# Step 10: Correlation on individual values
df_long["GroupID"] = df_long["Animal"].astype(str) + "_" + df_long["Session"].astype(str) + "_" + df_long["BaseSim"]

# Step 11: Split by source and align within groups
ecg = df_long[df_long["Source"] == "ECGenie"].copy().sort_values("GroupID").groupby("GroupID").apply(lambda x: x.reset_index(drop=True))
myalg = df_long[df_long["Source"] == "MyAlgorithm"].copy().sort_values("GroupID").groupby("GroupID").apply(lambda x: x.reset_index(drop=True))

merged = ecg[["GroupID", "HR"]].rename(columns={"HR": "HR_ECGenie"}).reset_index(drop=True)
merged["HR_MyAlgo"] = myalg["HR"].reset_index(drop=True)
merged[["Animal", "Session", "BaseSim"]] = merged["GroupID"].str.split("_", expand=True)

# Step 12: Plot individual correlation
plt.figure(figsize=(8, 6))
sns.scatterplot(data=merged, x="HR_MyAlgo", y="HR_ECGenie", hue="BaseSim", style="Animal", palette="Set2", s=100)
min_val = min(merged["HR_MyAlgo"].min(), merged["HR_ECGenie"].min())
max_val = max(merged["HR_MyAlgo"].max(), merged["HR_ECGenie"].max())
plt.plot([min_val, max_val], [min_val, max_val], 'r--', label='Perfect Correlation')
plt.xlabel("My Algorithm HR")
plt.ylabel("ECGenie HR")
plt.title("Correlation Between Individual HR Points")
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()

# Step 13: Pearson r on individual values
if len(merged) >= 2:
    r, p = pearsonr(merged["HR_MyAlgo"], merged["HR_ECGenie"])
    print(f"üìà Pearson Correlation (All Points): r = {r:.3f} (p = {p:.4f})")
else:
    print("‚ùå Not enough individual points for correlation.")

# Step 14: Correlation using averages
avg_df["Source"] = avg_df["Simulation"].apply(lambda x: "ECGenie" if x.endswith("-ECGenie") else "MyAlgorithm")
avg_df["BaseSim"] = avg_df["Simulation"].str.replace("-ECGenie", "", regex=False)
avg_df["Key"] = avg_df["Animal"].astype(str) + "_" + avg_df["Session"].astype(str) + "_" + avg_df["BaseSim"]

avg_algo = avg_df[avg_df["Source"] == "MyAlgorithm"]
avg_ecg = avg_df[avg_df["Source"] == "ECGenie"]

avg_merged = pd.merge(
    avg_algo[["Key", "HR", "Animal", "BaseSim"]],
    avg_ecg[["Key", "HR"]],
    on="Key",
    suffixes=("_MyAlgo", "_ECGenie")
)

# Step 15: Correlation plot for averages
plt.figure(figsize=(8, 6))
sns.scatterplot(data=avg_merged, x="HR_MyAlgo", y="HR_ECGenie", hue="BaseSim", style="Animal", palette="Set1", s=100)
min_val = min(avg_merged["HR_MyAlgo"].min(), avg_merged["HR_ECGenie"].min())
max_val = max(avg_merged["HR_MyAlgo"].max(), avg_merged["HR_ECGenie"].max())
plt.plot([min_val, max_val], [min_val, max_val], 'r--', label='Perfect Correlation')
plt.xlabel("My Algorithm Avg HR")
plt.ylabel("ECGenie Avg HR")
plt.title("üìä Correlation of AVERAGE HR Between My Algorithm and ECGenie")
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

# Step 16: Pearson r on averages
if len(avg_merged) >= 2:
    r_avg, p_avg = pearsonr(avg_merged["HR_MyAlgo"], avg_merged["HR_ECGenie"])
    print(f"üìà Pearson Correlation (Averages): r = {r_avg:.3f} (p = {p_avg:.4f})")
else:
    print("‚ùå Not enough averaged points for correlation.")

# Step 1: Filter only MyAlgorithm data
myalg_only = avg_df[avg_df["Source"] == "MyAlgorithm"].copy()

# Step 2: Strip ECGenie suffix if not already done
myalg_only["BaseSim"] = myalg_only["Simulation"].str.replace("-ECGenie", "", regex=False)

# Step 3: Group by simulation type and average across mice
grouped_avg = myalg_only.groupby("BaseSim")["HR"].mean().reset_index()

# Step 4: Merge averaged HR back for plotting with violin shape (add dummy mouse column)
myalg_only["BaseSim"] = myalg_only["Simulation"].str.replace("-ECGenie", "", regex=False)

# Plot: Violin of HR from MyAlgorithm across simulation types
plt.figure(figsize=(10, 6))
sns.violinplot(data=myalg_only, x="BaseSim", y="HR", inner="box", palette="Set2")
plt.title("MyAlgorithm: Heart Rate Comparison Across Simulation Types (Avg Across Mice)")
plt.xlabel("Simulation Type")
plt.ylabel("Heart Rate (BPM)")
plt.grid(True)
plt.tight_layout()
plt.show()



